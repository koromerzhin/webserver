version: "3"

networks:
  proxywebserver:
    driver: overlay
    external: true
  serverwebserver:
    driver: overlay
    external: true

volumes:
  traefik_certs:
  jenkins_data:
  nextcloud_data:
  portainer_data:
  mariadb_data:

services:
  redmine:
    image: redmine:6.1.0
    networks:
      - serverwebserver
      - proxywebserver
    depends_on:
      - mariadb
      - mailtest
    environment:
      - REDMINE_DB_MYSQL=mariadb
      - REDMINE_DB_USERNAME=redmine
      - REDMINE_DB_PASSWORD=passwordbdd
      - REDMINE_DB_DATABASE=redmine_bdd
    deploy:
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.redmine.rule=Host(`redmine.traefik.me`)"
        - "traefik.http.routers.redmine-tls.tls.domains[0].main=redmine.traefik.me"
        - "traefik.http.routers.redmine.tls=true"
        - "traefik.http.services.redmine.loadbalancer.server.port=3000"
  nextcloud:
    image: nextcloud:32.0.0-apache
    environment:
      - SMTP_HOST=mailtest
      - MYSQL_DATABASE=nextcloud_bdd
      - MYSQL_USER=nextcloud
      - MYSQL_PASSWORD=passwordbdd
      - MYSQL_HOST=mariadb
      - NEXTCLOUD_ADMIN_USER=admin
      - NEXTCLOUD_ADMIN_PASSWORD=password
      - NEXTCLOUD_TRUSTED_DOMAINS=nextcloud.traefik.me
    networks:
      - serverwebserver
      - proxywebserver
    volumes:
      - nextcloud_data:/var/www/html/data
    depends_on:
      - mariadb
    deploy:
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.nextcloud.rule=Host(`nextcloud.traefik.me`)"
        - "traefik.http.routers.nextcloud-tls.tls.domains[0].main=nextcloud.traefik.me"
        - "traefik.http.routers.nextcloud.tls=true"
        - "traefik.http.services.nextcloud.loadbalancer.server.port=80"
  jenkins:
    image: jenkins/jenkins:lts
    volumes:
      - jenkins_data:/var/jenkins_home
    networks:
      - serverwebserver
      - proxywebserver
    deploy:
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.jenkins.rule=Host(`jenkins.traefik.me`)"
        - "traefik.http.routers.jenkins-tls.tls.domains[0].main=jenkins.traefik.me"
        - "traefik.http.routers.jenkins.tls=true"
        - "traefik.http.services.jenkins.loadbalancer.server.port=8080"
  mercure:
    image: dunglas/mercure:v0.16
    environment:
      MERCURE_PUBLISHER_JWT_KEY: "SDDErzDziEaSFkO"
      MERCURE_SUBSCRIBER_JWT_KEY: "SDDErzDziEaSFkO"
      ALLOW_ANONYMOUS: 1
      PUBLISH_ALLOWED_ORIGINS: "*"
      CORS_ALLOWED_ORIGINS: "*"
    networks:
      - serverwebserver
    depends_on:
      - redis
    deploy:
      labels:
        - "traefik.enable=false"
  redis:
    image: redis:8.2.2
    networks:
      - serverwebserver
    deploy:
      labels:
        - "traefik.enable=false"
  mariadb:
    image: mariadb:12.0.2
    command: --transaction-isolation=READ-COMMITTED --binlog-format=ROW --innodb-file-per-table=1 --skip-innodb-read-only-compressed
    environment:
      MYSQL_ROOT_PASSWORD: example
      TZ: Europe/Paris
    volumes:
      - ${PWD}/mariadb_init:/docker-entrypoint-initdb.d
      - mariadb_data:/var/lib/mysql
      - ${PWD}/dump:/dump
    networks:
      - serverwebserver
    deploy:
      labels:
        - "traefik.enable=false"
  mailtest:
    image: axllent/mailpit:v1.27
    networks:
      - serverwebserver
      - proxywebserver
    deploy:
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.mailtest.rule=Host(`mailtest.traefik.me`)"
        - "traefik.http.routers.mailtest-tls.tls.domains[0].main=mailtest.traefik.me"
        - "traefik.http.routers.mailtest.tls=true"
        - "traefik.http.services.mailtest.loadbalancer.server.port=8025"
  phpmyadmin:
    image: phpmyadmin/phpmyadmin:5.2.3
    environment:
      PMA_HOST: mariadb
    depends_on:
      - mariadb
    networks:
      - serverwebserver
      - proxywebserver
    deploy:
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.phpmyadmin.rule=Host(`phpmyadmin.traefik.me`)"
        - "traefik.http.routers.phpmyadmin-tls.tls.domains[0].main=phpmyadmin.traefik.me"
        - "traefik.http.routers.phpmyadmin.tls=true"
        - "traefik.http.services.phpmyadmin.loadbalancer.server.port=80"
  portainer:
    image: portainer/portainer-ce:2.34.0
    networks:
      - proxywebserver
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data portainer/portainer-ce
    deploy:
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.portainer.rule=Host(`portainer.traefik.me`)"
        - "traefik.http.routers.portainer-tls.tls.domains[0].main=portainer.traefik.me"
        - "traefik.http.routers.portainer.tls=true"
        - "traefik.http.services.portainer.loadbalancer.server.port=9000"
  reverse:
    image: alpine
    command: sh -c "cd /etc/ssl/traefik && wget traefik.me/cert.pem -O cert.pem && wget traefik.me/privkey.pem -O privkey.pem"
    volumes:
      - traefik_certs:/etc/ssl/traefik
    deploy:
      restart_policy:
        condition: none
      labels:
        - "traefik.enable=false"
  traefik:
    image: traefik:v3.5.3
    environment:
      TZ: Europe/Paris
    # Enables the web UI and tells Traefik to listen to docker
    ports:
      - target: 80
        published: 80
        protocol: tcp
        mode: host 
      - target: 443
        published: 443
        protocol: tcp
        mode: host 
    networks:
      - proxywebserver
    volumes:
      # So that Traefik can listen to the Docker events
      - ${PWD}/letsencrypt:/letsencrypt
      - /var/run/docker.sock:/var/run/docker.sock
      - ${PWD}/traefik/traefik.yml:/etc/traefik/traefik.yml
      - ${PWD}/traefik/middlewares.yml:/etc/traefik/middlewares.yml
      - traefik_certs:/etc/ssl/traefik
    deploy:
      placement:
        constraints:
          - node.role == manager
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.proxy.rule=Host(`proxy.traefik.me`)"
        - "traefik.http.routers.proxy-tls.tls.domains[0].main=proxy.traefik.me"
        - "traefik.http.routers.proxy.tls=true"
        - "traefik.http.services.proxy.loadbalancer.server.port=8080"
